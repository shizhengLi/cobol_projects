# 子程序连接规格

本文档定义了保险会计系统中使用的子程序的连接规格，包括子程序名称、输入/输出参数、参数属性、位数、编辑要领和备注等。

## 子程序 INSPOLVD - 保单验证子程序

### 描述
验证保单ID是否存在于保单表中。接收保单ID，返回SQL操作结果代码。

### 输入参数
| 参数ID | 参数名 | 属性 | 位数 | 重复次数 | 编辑要领 | 备注 |
|--------|-------|------|-----|---------|---------|------|
| 1 | LS-POLICY-ID | X型 | 10 | 1 | 设置保单ID | 要验证的保单标识符 |

### 输出参数
| 参数ID | 参数名 | 属性 | 位数 | 重复次数 | 编辑要领 | 备注 |
|--------|-------|------|-----|---------|---------|------|
| 2 | LS-SQLCODE | S9(9) COMP型 | 4 | 1 | SQL操作结果代码 | 0=保单存在<br>100=保单不存在<br>负值=错误 |

### 调用示例
```cobol
CALL 'INSPOLVD' USING PR-POLICY-ID SQLCODE
```

### 调用流程
1. 调用前，设置保单ID参数（PR-POLICY-ID）
2. 调用子程序
3. 调用后，检查返回的SQL代码（SQLCODE）
   - 如果SQLCODE = 0，表示保单存在，继续处理
   - 如果SQLCODE <> 0，表示保单不存在或发生错误，记录错误

## 子程序 INSPMINS - 支付记录插入子程序

### 描述
将支付记录插入到保费支付表中。接收支付记录结构和会计期间，返回SQL操作结果代码。

### 输入参数
| 参数ID | 参数名 | 属性 | 位数 | 重复次数 | 编辑要领 | 备注 |
|--------|-------|------|-----|---------|---------|------|
| 1 | PAYMENT-RECORD | 复合结构 | 48 | 1 | 设置支付记录结构 | 包含保单ID、支付日期等字段 |
| 2 | LS-ACCOUNTING-PERIOD | X型 | 6 | 1 | 设置会计期间 | 格式为YYYYMM |

### 输出参数
| 参数ID | 参数名 | 属性 | 位数 | 重复次数 | 编辑要领 | 备注 |
|--------|-------|------|-----|---------|---------|------|
| 3 | LS-SQLCODE | S9(9) COMP型 | 4 | 1 | SQL操作结果代码 | 0=插入成功<br>-803=记录已存在<br>其他负值=错误 |

### 调用示例
```cobol
CALL 'INSPMINS' USING PAYMENT-RECORD
                       WS-ACCOUNTING-PERIOD
                       SQLCODE
```

### 调用流程
1. 调用前，设置支付记录参数（PAYMENT-RECORD）和会计期间参数（WS-ACCOUNTING-PERIOD）
2. 调用子程序
3. 调用后，检查返回的SQL代码（SQLCODE）
   - 如果SQLCODE = 0，表示插入成功，设置处理结果为'SUCCESS'
   - 如果SQLCODE <> 0，表示插入失败，设置处理结果为'FAILED'，增加错误计数

## 子程序 INSPMLOG_EN - 日志记录子程序

### 描述
记录程序执行日志。接收日志参数结构，包括日志级别、模块名和消息，将格式化日志写入到日志文件。

### 输入参数
| 参数ID | 参数名 | 属性 | 位数 | 重复次数 | 编辑要领 | 备注 |
|--------|-------|------|-----|---------|---------|------|
| 1 | LOG-PARAMS | 复合结构 | 109 | 1 | 设置日志参数结构 | 包含日志级别、模块名和消息 |

### 输出参数
| 参数ID | 参数名 | 属性 | 位数 | 重复次数 | 编辑要领 | 备注 |
|--------|-------|------|-----|---------|---------|------|
| （包含在LOG-PARAMS中） | LOG-RETURN-CODE | X型 | 1 | 1 | 日志操作结果代码 | 0=成功<br>9=失败 |

### 调用示例
```cobol
MOVE 'I' TO LOG-LEVEL
MOVE 'INSPMUPD' TO LOG-MODULE
MOVE 'Premium payment processing started' TO LOG-MESSAGE
CALL 'INSPMLOG_EN' USING LOG-PARAMS
```

### 调用流程
1. 调用前，设置日志级别（LOG-LEVEL）、模块名（LOG-MODULE）和消息内容（LOG-MESSAGE）
2. 调用子程序
3. 调用后，子程序将日志写入日志文件，但当前实现不检查返回代码

## 参数详细结构

### PAYMENT-RECORD 支付记录结构
```cobol
01 PAYMENT-RECORD.
   05 PR-POLICY-ID            PIC X(10).
   05 PR-PAYMENT-DATE         PIC X(8).
   05 PR-PAYMENT-METHOD       PIC X(2).
   05 PR-AMOUNT               PIC 9(8)V99.
   05 PR-PAYMENT-ID           PIC X(12).
   05 PR-REFERENCE-NO         PIC X(16).
```

### LOG-PARAMS 日志参数结构
```cobol
01 LOG-PARAMS.
   05 LOG-LEVEL              PIC X.
      88 LOG-INFO            VALUE 'I'.
      88 LOG-WARNING         VALUE 'W'.
      88 LOG-ERROR           VALUE 'E'.
      88 LOG-DEBUG           VALUE 'D'.
   05 LOG-MODULE             PIC X(8).
   05 LOG-MESSAGE            PIC X(100).
   05 LOG-RETURN-CODE        PIC X.
      88 LOG-SUCCESS         VALUE '0'.
      88 LOG-FAILURE         VALUE '9'.
```

## 子程序调用顺序图

```
+-------------+                 +--------------+
|             |    验证保单ID     |              |
|  INSPMUPD   | --------------> |   INSPOLVD   |
|             | <-------------- |              |
+-------------+    返回SQLCODE    +--------------+
       |
       | 如果保单存在（SQLCODE = 0）
       v
+-------------+                 +--------------+
|             |    插入支付记录    |              |
|  INSPMUPD   | --------------> |   INSPMINS   |
|             | <-------------- |              |
+-------------+    返回SQLCODE    +--------------+
       |
       | 程序开始和结束
       v
+-------------+                 +--------------+
|             |    记录日志      |              |
|  INSPMUPD   | --------------> | INSPMLOG_EN  |
|             | <-------------- |              |
+-------------+   返回LOG-RETURN-CODE   +--------------+
```

## 错误处理

### INSPOLVD 子程序
- 如果保单ID不存在，返回SQLCODE = 100
- 实际环境中如果发生数据库错误，将返回相应的SQLCODE负值

### INSPMINS 子程序
- 如果支付记录已存在（重复键），返回SQLCODE = -803
- 实际环境中如果发生其他数据库错误，将返回相应的SQLCODE负值

### INSPMLOG_EN 子程序
- 当前实现总是返回LOG-RETURN-CODE = '0'（成功）
- 实际环境中如果发生文件写入错误，应返回LOG-RETURN-CODE = '9'（失败）

## 调用频率和性能考虑

1. INSPOLVD 子程序：每条支付记录调用一次，需要优化数据库查询性能
2. INSPMINS 子程序：对每条验证通过的支付记录调用一次，需要优化数据库插入性能
3. INSPMLOG_EN 子程序：程序开始和结束时各调用一次，不在主处理循环中调用，对性能影响较小 
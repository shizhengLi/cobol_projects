# 处理概要

## 处理概要说明

保险会计系统的主程序 INSPMUPD_EN 执行保费支付处理批处理操作。系统从外部输入文件读取保费支付记录，验证保单是否存在，然后将有效的支付记录插入到数据库，并生成处理报告和日志。

处理流程可以概括为以下几个主要步骤：

1. **初始化处理**：初始化变量、计数器和标志；获取当前日期和时间；设置会计期间；打开输入输出文件；写入报表头部信息；记录开始日志。

2. **数据处理**：从输入文件读取支付记录；解析记录字段；调用保单验证子程序检查保单ID是否存在；对于有效保单，调用支付记录插入子程序；格式化处理结果信息；写入报表明细行。

3. **结束处理**：汇总处理结果；写入报表汇总信息；记录结束日志；关闭所有文件。

整个处理过程涉及三个子程序的调用：保单验证子程序(INSPOLVD)、支付记录插入子程序(INSPMINS)和日志记录子程序(INSPMLOG_EN)。

## 处理概要图

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  初始化处理     | --> |  数据处理循环   | --> |  结束处理      |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                             |
                             v
          +----------------------------------------+
          |                                        |
          v                                        v
+----------------+                        +----------------+
|                |                        |                |
|  保单验证子程序  | -- 有效保单 ------>      |  支付记录插入    |
|  (INSPOLVD)    |                        |  子程序         |
|                | <-- SQL返回码 -------   |  (INSPMINS)    |
+----------------+                        |                |
                                          +----------------+
                                                  |
                                                  v
                                          +----------------+
                                          |                |
                                          |  处理结果格式化  |
                                          |  及报表输出     |
                                          |                |
                                          +----------------+
                                                  |
                                                  v
                                          +----------------+
                                          |                |
                                          |  日志记录子程序  |
                                          |  (INSPMLOG_EN) |
                                          |                |
                                          +----------------+
```

## 数据流图

```
+-------------+         +-------------+         +-------------+
|             |         |             |         |             |
| 支付更新文件  | ------> |  INSPMUPD   | ------> |  处理报告文件 |
|             |         |             |         |             |
+-------------+         +-------------+         +-------------+
                             |
                             v
                      +-------------+         +-------------+
                      |             |         |             |
                      |  INSPOLVD   | <-----> | 保单表       |
                      |             |         |             |
                      +-------------+         +-------------+
                             |
                             v
                      +-------------+         +-------------+
                      |             |         |             |
                      |  INSPMINS   | ------> | 支付记录表   |
                      |             |         |             |
                      +-------------+         +-------------+
                             |
                             v
                      +-------------+         +-------------+
                      |             |         |             |
                      | INSPMLOG_EN | ------> |  日志文件    |
                      |             |         |             |
                      +-------------+         +-------------+
```

注：这几个文件对应于下面的表

1. 支付更新文件：PAYMENT-FILE
2. 保单表：INSURANCE_POLICY
3. 支付记录表：PREMIUM_PAYMENT
4. 处理报告文件：REPORT-FILE
5. 日志文件：LOG-FILE

## 与其他工作的关系

## 实行条件

保险会计系统的保费支付处理批处理程序按照以下条件执行：

1. **定时执行**：每天23:00自动运行，处理当天收到的保费支付记录。
2. **手动触发**：在特殊情况下，可以由操作员手动触发执行。
3. **错误重试**：如果批处理执行失败，系统将在30分钟后自动重试，最多重试3次。
4. **前置条件**：
   - 保单表和客户表数据已经完成日常更新
   - 支付更新文件已经准备就绪
   - 数据库连接可用

## 入出力CRUD表

下表描述了系统对各表/文件的创建(C)、读取(R)、更新(U)和删除(D)操作：

| 表/文件名称 | 创建(C) | 读取(R) | 更新(U) | 删除(D) |
|------------|--------|--------|--------|--------|
| CUSTOMER | | ✓ | | |
| INSURANCE_POLICY | | ✓ |✓ | |
| PREMIUM_PAYMENT | ✓ | ✓|✓ | |
| PAYMENT-FILE | | ✓ | | |
| REPORT-FILE |  |✓ | ✓| |
| LOG-FILE | | ✓ | ✓| | 
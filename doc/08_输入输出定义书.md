 # 输入输出定义书

本文档详细定义了保险会计系统中的数据处理流程，包括输入表/文件、条件、编辑内容、输出表/文件、输出类型和输出条件等。

## 保费支付记录处理步骤

### STEP1: 记录读取与解析

| 编号 | 输入表/文件名 | 条件 | 输入项目名 | 编辑内容 | 输出表/文件名 | 输出类型 | 输出条件 | 项目名 | 备注 |
|------|--------------|------|-----------|----------|--------------|---------|----------|--------|------|
| 1 | PAYMENT-FILE | - | PAYMENT-RECORD-IN | 提取字段 | - | - | - | PR-POLICY-ID | 保单ID |
| 2 | PAYMENT-FILE | - | PAYMENT-RECORD-IN | 提取字段 | - | - | - | PR-PAYMENT-DATE | 支付日期 |
| 3 | PAYMENT-FILE | - | PAYMENT-RECORD-IN | 提取字段 | - | - | - | PR-PAYMENT-METHOD | 支付方式 |
| 4 | PAYMENT-FILE | - | PAYMENT-RECORD-IN | 转换为数值 | - | - | - | PR-AMOUNT | 支付金额 |
| 5 | PAYMENT-FILE | - | PAYMENT-RECORD-IN | 提取字段 | - | - | - | PR-PAYMENT-ID | 支付ID |
| 6 | PAYMENT-FILE | - | PAYMENT-RECORD-IN | 提取字段 | - | - | - | PR-REFERENCE-NO | 参考编号 |

### STEP2: 保单验证

| 编号 | 输入表/文件名 | 条件 | 输入项目名 | 编辑内容 | 输出表/文件名 | 输出类型 | 输出条件 | 项目名 | 备注 |
|------|--------------|------|-----------|----------|--------------|---------|----------|--------|------|
| 7 | - | - | PR-POLICY-ID | - | INSURANCE_POLICY | SELECT | - | POLICY_ID | 查询保单是否存在 |
| 8 | INSURANCE_POLICY | SQLCODE = 0 | - | - | - | - | - | - | 保单存在 |
| 9 | INSURANCE_POLICY | SQLCODE <> 0 | - | 设置"NO POLICY" | - | - | - | DL-RESULT | 保单不存在 |

### STEP3: 支付记录插入

| 编号 | 输入表/文件名 | 条件 | 输入项目名 | 编辑内容 | 输出表/文件名 | 输出类型 | 输出条件 | 项目名 | 备注 |
|------|--------------|------|-----------|----------|--------------|---------|----------|--------|------|
| 10 | - | SQLCODE = 0（保单存在） | PAYMENT-RECORD | - | PREMIUM_PAYMENT | INSERT | - | - | 插入支付记录 |
| 11 | - | - | PR-POLICY-ID | - | PREMIUM_PAYMENT | INSERT | - | POLICY_ID | 保单ID |
| 12 | - | - | PR-PAYMENT-DATE | - | PREMIUM_PAYMENT | INSERT | - | PAYMENT_DATE | 支付日期 |
| 13 | - | - | PR-AMOUNT | - | PREMIUM_PAYMENT | INSERT | - | AMOUNT | 支付金额 |
| 14 | - | - | PR-PAYMENT-METHOD | - | PREMIUM_PAYMENT | INSERT | - | PAYMENT_METHOD | 支付方式 |
| 15 | - | - | - | 设置为'P' | PREMIUM_PAYMENT | INSERT | - | PAYMENT_STATUS | 支付状态 |
| 16 | - | - | WS-ACCOUNTING-PERIOD | - | PREMIUM_PAYMENT | INSERT | - | ACCOUNTING_PERIOD | 会计期间 |
| 17 | - | - | PR-REFERENCE-NO | - | PREMIUM_PAYMENT | INSERT | - | REFERENCE_NO | 参考编号 |
| 18 | - | - | - | 设置为'INSACC' | PREMIUM_PAYMENT | INSERT | - | CREATE_USER | 创建用户 |
| 19 | - | - | - | 设置当前时间戳 | PREMIUM_PAYMENT | INSERT | - | CREATE_TIMESTAMP | 创建时间戳 |

### STEP4: 报表明细生成

| 编号 | 输入表/文件名 | 条件 | 输入项目名 | 编辑内容 | 输出表/文件名 | 输出类型 | 输出条件 | 项目名 | 备注 |
|------|--------------|------|-----------|----------|--------------|---------|----------|--------|------|
| 20 | - | - | PR-POLICY-ID | - | REPORT-FILE | WRITE | - | DL-POLICY-ID | 保单ID |
| 21 | - | - | PR-PAYMENT-DATE | 转换为YYYY-MM-DD格式 | REPORT-FILE | WRITE | - | DL-PAYMENT-DATE | 支付日期 |
| 22 | - | - | PR-PAYMENT-METHOD | 根据代码转换为文本描述 | REPORT-FILE | WRITE | - | DL-PAYMENT-METHOD | 支付方式 |
| 23 | - | - | PR-AMOUNT | 格式化为数字 | REPORT-FILE | WRITE | - | DL-AMOUNT | 支付金额 |
| 24 | - | - | PR-PAYMENT-ID | - | REPORT-FILE | WRITE | - | DL-PAYMENT-ID | 支付ID |
| 25 | - | - | PR-REFERENCE-NO | - | REPORT-FILE | WRITE | - | DL-REFERENCE-NO | 参考编号 |
| 26 | - | SQLCODE = 0（插入成功） | - | 设置为'SUCCESS' | REPORT-FILE | WRITE | - | DL-RESULT | 处理结果 |
| 27 | - | SQLCODE <> 0（插入失败） | - | 设置为'FAILED' | REPORT-FILE | WRITE | - | DL-RESULT | 处理结果 |

### STEP5: 报表汇总生成

| 编号 | 输入表/文件名 | 条件 | 输入项目名 | 编辑内容 | 输出表/文件名 | 输出类型 | 输出条件 | 项目名 | 备注 |
|------|--------------|------|-----------|----------|--------------|---------|----------|--------|------|
| 28 | - | - | WS-PROCESS-COUNT | 格式化为数字 | REPORT-FILE | WRITE | - | TL-TOTAL-PROCESSED | 处理总数 |
| 29 | - | - | WS-ERROR-COUNT | 格式化为数字 | REPORT-FILE | WRITE | - | TL-TOTAL-ERRORS | 错误总数 |

### STEP6: 日志记录

| 编号 | 输入表/文件名 | 条件 | 输入项目名 | 编辑内容 | 输出表/文件名 | 输出类型 | 输出条件 | 项目名 | 备注 |
|------|--------------|------|-----------|----------|--------------|---------|----------|--------|------|
| 30 | - | 程序开始 | - | 设置为'I' | - | - | - | LOG-LEVEL | 信息级别 |
| 31 | - | 程序开始 | - | 设置为'INSPMUPD' | - | - | - | LOG-MODULE | 模块名 |
| 32 | - | 程序开始 | - | 设置为'Premium payment processing started' | - | - | - | LOG-MESSAGE | 开始消息 |
| 33 | - | 程序开始 | LOG-PARAMS | 格式化日志记录 | LOG-FILE | WRITE | - | LOG-RECORD | 日志记录 |
| 34 | - | 程序结束 | - | 设置为'I' | - | - | - | LOG-LEVEL | 信息级别 |
| 35 | - | 程序结束 | - | 设置为'INSPMUPD' | - | - | - | LOG-MODULE | 模块名 |
| 36 | - | 程序结束 | WS-PROCESS-COUNT, WS-ERROR-COUNT | 组合处理统计信息 | - | - | - | LOG-MESSAGE | 结束消息 |
| 37 | - | 程序结束 | LOG-PARAMS | 格式化日志记录 | LOG-FILE | WRITE | - | LOG-RECORD | 日志记录 |

## 数据编辑规则

### 日期格式转换

支付日期从YYYYMMDD格式转换为YYYY-MM-DD格式，转换规则如下：

```cobol
STRING PR-PAYMENT-DATE(1:4) DELIMITED BY SIZE
       '-'
       PR-PAYMENT-DATE(5:2) DELIMITED BY SIZE
       '-'
       PR-PAYMENT-DATE(7:2) DELIMITED BY SIZE
  INTO DL-PAYMENT-DATE
END-STRING
```

### 支付方式代码转换

支付方式代码转换为可读文本描述，转换规则如下：

```cobol
EVALUATE PR-PAYMENT-METHOD
    WHEN '01'
        MOVE 'BANK' TO DL-PAYMENT-METHOD
    WHEN '02'
        MOVE 'CREDIT' TO DL-PAYMENT-METHOD
    WHEN '03'
        MOVE 'CASH' TO DL-PAYMENT-METHOD
    WHEN OTHER
        MOVE 'UNKNOWN' TO DL-PAYMENT-METHOD
END-EVALUATE
```

### 时间戳生成

系统日期时间格式化为时间戳，格式化规则如下：

```cobol
STRING WS-CURRENT-YEAR
       WS-CURRENT-MONTH
       WS-CURRENT-DAY
       WS-CURRENT-HOUR
       WS-CURRENT-MINUTE
       WS-CURRENT-SECOND
  DELIMITED BY SIZE
  INTO WS-TIMESTAMP
END-STRING
```

## 输入输出关系图

```
+----------------+
|                |
| PAYMENT-FILE   |
|                |
+--------+-------+
         |
         | 读取解析
         v
+--------+-------+
|                |
| PAYMENT-RECORD |
|                |
+--------+-------+
         |
         | 验证
         v
+--------+-------+     +----------------+
|                |     |                |
| PR-POLICY-ID   | --> | INSURANCE_     |
|                |     | POLICY         |
+--------+-------+     +----------------+
         |
         | 插入
         v
+--------+-------+
|                |
| PREMIUM_       |
| PAYMENT        |
|                |
+--------+-------+
         |
         | 报告
         v
+--------+-------+
|                |
| REPORT-FILE    |
|                |
+----------------+
         |
         | 日志
         v
+--------+-------+
|                |
| LOG-FILE       |
|                |
+----------------+
```